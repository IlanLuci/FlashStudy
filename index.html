<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">

        <title>Flash Study</title>
        
        <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4216468674789814" crossorigin="anonymous"></script>

        <link rel="stylesheet" href="main.css">
        <style>
            
            button:hover {
                background-color: #0390fc;
            }

            .create {
                margin-top: 10px;
            }
            #errors {
                display: none;
                position: fixed;
                top: 100px;
                font-size: 15pt;
                right: 10px;
            }
            #footer {
                position: fixed;
                padding: 5px;
                bottom: -20px;
                left: 0;
                width: 100%;
                text-align: center;
                height: 30px;
                background-color: #5c5ac6;
                font-size: 14pt;
            }
            .set {
                margin-bottom: 20px;
                margin: 10px;
                border-radius: 8px;
                padding: 8px;
                display: inline-block;
                border: 3px solid #222;
                padding-bottom: 10px;
                text-align: center;
            }
            .name {
                font-size: 15pt;
            }
            hr {
                border: 2px solid #222;
            }

            input {
                border: 2px solid #222;
                border-radius: 8px;
                padding: 10px;
                outline: none;
                width: 250px;
                background-color:#5c5ac6;
            }
            input::placeholder {
                color: #222;
            }
            input:hover, input:focus {
                background-color: #0390fc;
            }

            #search {
                position: absolute;
                top: 25px;
                left: calc(50% - 19px);
                transform: translate(-50%);
            }
            #search-icon {
                position: absolute;
                top: 25px;
                left: calc(50% + 131px);
                transform: translate(-50%);
                padding: 4.5px;
                border-radius: 8px;
                border: 2px solid #222;
                cursor: pointer;
            }

            #searched {
                white-space: nowrap;
                position: absolute;
                overflow-x: scroll;
                width: 100%;
                top: 150px;
                left: 50%;
                transform: translate(-50%);
                text-align: center;
            }

            #description {
                font-size: 15pt;
                margin: 120px 10px;
            }

            #load {
                margin: 190px 10px 0px calc(100% - 100px);
                font-size: 15pt;
                cursor: pointer;
                -ms-user-select: none;
                -moz-user-select: none;
                -khtml-user-select: none;
                -webkit-user-select: none;
                user-select: none;
            }
            #load:hover {
                text-decoration: underline;
            }
            #title {
                top: 5px;
                left: 10px;
                transform: none;
                padding: 3px 10px 5px 10px;
            }
            #title::before {
                content: "";
                position: absolute;
                width: 100%;
                height: calc(100% + 5px);
                left: -2px;
                top: -3px;
                z-index: -1;
                background: #0390fc 0 0;
                transform: rotate(5deg);
                border-top-left-radius: 80px;
                border-top-right-radius: 40px;
                border-bottom-left-radius: 20px;
                border-bottom-right-radius: 70px;
            }
        </style>
    </head>

    <body>
        <svg onclick="location.href = 'login.html'" id="profile" xmlns="http://www.w3.org/2000/svg" width="42" height="42" fill="currentColor" class="bi bi-person" viewBox="0 0 16 16">
            <path d="M8 8a3 3 0 1 0 0-6 3 3 0 0 0 0 6Zm2-3a2 2 0 1 1-4 0 2 2 0 0 1 4 0Zm4 8c0 1-1 1-1 1H3s-1 0-1-1 1-4 6-4 6 3 6 4Zm-1-.004c-.001-.246-.154-.986-.832-1.664C11.516 10.68 10.289 10 8 10c-2.29 0-3.516.68-4.168 1.332-.678.678-.83 1.418-.832 1.664h10Z"/>
        </svg>
        
        <button onclick="dropdown();" id="new">Create</button>
        <div id="dropdown" class="dropdown-content">
            <a href="create-set.html">Create New Set</a>
            <a href="create-note.html">Create New Note</a>
        </div>

        <h1 id="title">Flash Study</h1>

        <input id="search" type="text" placeholder="search flash sets">

        <svg onclick="search();" id="search-icon" xmlns="http://www.w3.org/2000/svg" width="26" height="26" fill="currentColor" class="bi bi-search" viewBox="0 0 16 16">
            <path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z"/>
        </svg>

        <p id="description">Popular Flash Sets</p>
        <p id="errors">all sets are displayed</p>

        <div id="searched"></div>

        <p id="load" onclick="loadMore();">load more</p>
        
        <p id="footer">Created by Ilan L and Chris O. Please reach out with any suggestions.</p>
        <!--<p id="footer">click <a href="accents.html">here</a> for the spanish accents copy-paste tool</p>-->

        <script src="main.js?v1"></script>
        <script>
            const setsPerPage = 5;

            let setsLoaded = 0;
            let queryLoaded;

            window.addEventListener('load', async () => {
                let profile = document.getElementById('profile');
                let searched = document.getElementById('searched');

                let response = await fetcher(`/auth/check`);
                let result = await response.text();

                if (result == 'A token is required for authentication' || result == 'Invalid Token') {
                    // not logged into any account, proceed as normal
                } else {
                    let json = JSON.parse(result);

                    profile.setAttribute('onclick', `location.href = 'profile.html'`);
                }

                loadPopular();
            });
            window.addEventListener('keypress', (e) => {
                if (e.key == 'Enter' && document.activeElement == document.getElementById('search')) search();
            });

            async function search(e) {
                let query = document.getElementById('search').value.trim();
                let searched = document.getElementById('searched');
                let description = document.getElementById('description');
                let load = document.getElementById('load');

                if (query == '') return loadPopular();

                queryLoaded = query;
                searched.innerText = '';
                description.innerText = query + ' Flash Sets';
                load.onclick = loadMoreSearch;
                setsLoaded = 0;

                let res = await fetcher(`/sets/search`, { method: 'post', body: JSON.stringify({ order: 1, query: query }), headers: { 'Content-Type': 'application/json' }});

                let text = await res.text();

                if (res.status == 201) {
                    if (text == 'all sets are displayed') {
                            searched.innerHTML += 'there are no sets matching your search';
                    } else {
                        let json = JSON.parse(text);

                        for (set in json) {
                            setsLoaded += 1;

                            addSet(json[set].name, json[set].creator, json[set].id);
                        }
                    }
                } else {
                    console.log(text)
                }
            }

            async function loadMore() {
                let searched = document.getElementById('searched');

                // load next setsPerPage popular flash sets
                let res = await fetcher(`/sets/popular`, { method: 'post', body: JSON.stringify({ order: setsLoaded / setsPerPage + 1 }), headers: { 'Content-Type': 'application/json' }});

                if (res.status == 201) {
                    let json = await res.json();

                    for (set in json) {
                        setsLoaded += 1;

                        addSet(json[set].name, json[set].creator, json[set].id);
                    }

                    if (json.length == 0) {
                        document.getElementById('errors').style.display = 'block';

                        setTimeout(() => {
                        document.getElementById('errors').style.display = 'none';
                        }, 1500);

                        return;
                    }
                } else {
                    console.log(text)
                }
            }
            async function loadMoreSearch() {
                let searched = document.getElementById('searched');

                // load next setsPerPage popular flash sets
                let res = await fetcher(`/sets/search`, { method: 'post', body: JSON.stringify({ order: setsLoaded / setsPerPage + 1, query: queryLoaded }), headers: { 'Content-Type': 'application/json' }});

                let text = await res.text();
                if (res.status == 201) {

                    if (text == 'all sets are displayed') {
                        document.getElementById('errors').style.display = 'block';

                        setTimeout(() => {
                        document.getElementById('errors').style.display = 'none';
                        }, 1500);

                        return;
                    } else {
                        let json = JSON.parse(text);

                        for (set in json) {
                            setsLoaded += 1;

                            addSet(json[set].name, json[set].creator, json[set].id);
                        }
                    }
                } else {
                    console.log(text)
                }
            }

            function addSet(name, creator, id) {
                let searched = document.getElementById('searched');

                searched.innerHTML += `
                    <div class="set">
                        <p class="name">${name}</p>

                        <p>Created By ${creator}</p>

                        <button onclick="location.assign('flashcards.html?id=${id}');">Study With Flashcards</button>
                        <button onclick="location.assign('study.html?id=${id}');">Study with Questions</button>
                    </div>
                `;
            }

            async function loadPopular() {
                queryLoaded = '';
                searched.innerText = '';
                setsLoaded = 0;
                description.innerText = 'Popular Flash Sets';
                load.onclick = loadMore;

                // load popular flash sets
                let res = await fetcher(`/sets/popular`, { method: 'post', body: JSON.stringify({ order: 1 }), headers: { 'Content-Type': 'application/json' }});

                if (res.status == 201) {
                    let json = await res.json();

                    for (set in json) {
                        setsLoaded += 1;

                        addSet(json[set].name, json[set].creator, json[set].id);
                    }
                } else {
                    console.log(text)
                }
            }
        </script>
    </body>
</html>